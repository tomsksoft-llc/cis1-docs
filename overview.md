# Continuous Integration System, Version 1

Это файл overview.html репозитария cis1-docs.

В нем содержится описание системы, состав компонент, бизнес-логика системы и каждой компоненты по отдельности, описание взаимодействия между компонентами. Версию системы можно найти в файле version.txt этого же репозитария.

Кроме требований к бизнес-логике и интерфейсу компоненты, имеются требования на состав документации и правила организации репозитариев. Их можно найти [здесь](devguide.md).

Каждая компонента должна удовлетворять требованиям, изложенным в данных документах.

# Что такое CIS, зачем она нужна

CIS - это инструмент для разработчиков программного обеспечения.

Он предназначен для автоматизации и связывания в единую цепочку рутинных операций, которые присутствуют в жизненном цикле ПО.

Это операции: сборки (build), развертывания (deploy), автотестирования (autotesting), диагностика состояния систем (по запросу и периодическая), и т.д.

Смысл использования этого инструмента: исключить из процесса разработки ручной запуск рутинных операций, и тем самым повысить эффективность работы инженеров.

# Общее описание бизнес-логики системы

## Система реализует следующие функции:

*   ВЕБ интерфейс для пользователя. Все функции системы и управление ей доступны через этот интерфейс.
*   Запуск скриптов (job), сохранение результатов каждого запуска (билда) и их идентификацию, вывода на консоль каждого запуска, статуса завершения.  
    Любой скрипт может иметь параметры.  
    Любой скрипт может запустить еще один скрипт.  
    Каждый скрипт - это исполняемый файл с точки зрения ОС.  

*   Скрипты разбиты на группы - проекты. Каждый проект - это отдельный каталог, он может быть репозитарием.
*   Создание/модификацию/удаление скриптов.
*   Скрипты могут запускаться не только через ВЕБ интерфейс, но и из командной строки.
*   Существуют версии системы для Win, Linux, Mac.
*   Возможность запуска скриптов по расписанию.
*   Возможность запуска скриптов по внешнему сигналу - ВЕБ-хуку.
*   Возможность запуска скриптов из самих скриптов (организация цепочек - сессий).
*   Наличие механизма глобальных переменных сессии (эти переменные доступны всем задачам, выполняющимся в пределах этой сессии).
*   Визуализация процесса работы скриптов, работы цепочки скриптов.
*   Удаление старых билдов.
*   Самодиагностику работоспособности системы.
*   Разделение правд доступа к проектам через ВЕБ интерфейс.
*   ...

# Список компонентов

*   Ядро (core).
*   ВЕБ интерфейс (WEBUI).

# Описание бизнес логики ядра

## Основные термины

<table>

<tbody>

<tr>

<td>_cis_base_dir_</td>

<td>это системная переменная, которая должна быть установлена в environment и в ней должно быть имя каталога в котором находится система.  
</td>

</tr>

<tr>

<td>Ядро</td>

<td>несколько скриптов, которые обеспечивают все функции системы, скрипты находятся в подкаталоге _core_.</td>

</tr>

<tr>

<td>Проект</td>

<td>Подкаталог внутри каталога _jobs_, внутри него находятся принадлежащие ему задачи.</td>

</tr>

<tr>

<td>Задача</td>

<td>это и каталог, который содержит все необходимое для запуска/результаты запуска, и сам процесс выполнения задачи.</td>

</tr>

<tr>

<td>Билд</td>

<td>это один сеанс работы задачи, а также и результаты его выполнения, каждый билд выполняется в отдельном подкаталоге внутри задачи (имя подкаталога билда - это его номер).</td>

</tr>

<tr>

<td>Сессия</td>

<td>задачи могут запускать одна другую, таким образом организовывая цепочки выполнения - это и есть сессии. Первая задача в цепочке начинает сессию, и она же ее закрывает. При открытии сессии ей присваивается уникальный идентификатор. Для каждой сессии создается отдельный файл лога в каталоге _sessions_, имя лог-файла совпадает с идентификатором сессии.</td>

</tr>

</tbody>

</table>

## Задачи (jobs)

Задачи находятся в подкаталоге _jobs_ системы. Все задачи разбиты на "проекты", каждый из проектов находится в своем подкаталоге.

Внутри каталога задачи находятся:

*   подкаталоги 000001 - 999999 - здесь хранятся данные билдов (результаты).
*   файл _script_ - это скрипт самой задачи, он и выполняется
*   файл _params_ - описание входных параметров задачи
*   файл _config_ - параметры, которые cis использует в своих целях

## Размещение системы на диске

<pre>\core – ядро CIS (здесь находятся исполняемые файлы, которые и обеспечивают работу ядра)
\jobs  - каталог с «задачами», они разбиты на проекты:
-\internal – специальный проект, который включен прямо в CIS, это всякие служебные ее задачи
   -\job1
	-\script - скрипт этой job
	-\param - файл параметров этой job
	-\config - конфигурационный файл этой job
	-\000001 - каталог, в котором лежат результаты выполнения первого билда этой job
		-\script - файл скрипта, который запускался для выполнения этого билда 
			   (в момент старата билда он копируется из каталога выше)
		-\output.txt - содержимое стандартного вывода и вывода ошибок, которое было сформировано в процессе билда
		-\exitcode.txt - в этом файле записан код возврата сркипта этой job
		-\session_id.txt - в этом файле записан идентификатор сессии, в которой запускалася этот билд
   - job2
   -\...
-\project1 – сторонний проект, здесь находятся зачади, сделанные разработчиками проекта, этот проект хранится в другом репозитарии (не связанном с CIS)
   -\job1
   -\job2
   -...
  -... – куча других проектов
\logs – логфайлы работы CIS
\sessions  - здесь находятся логи сессий (логи запусков цепочек jobs), они нам нужны для визуализации работы системы
</pre>

## Запуск задачи

Для запуска задачи используем команду системы _startjob_ с параметром проект/задача:

<pre>$cis_base_dir/startjob internal/core_test
</pre>

Если у задачи есть входные параметры, то они будут запрошены с консоли в той последовательности, в которой они указаны в файле paprms.  
На выход будут три строки, в первой будет идентификатор сессии, во второй информация о старте задачи, ее имя, номер билда и т.д., в третьей статус завершения:

<pre>$ ./startjob internal/core_test
2019-01-08-13-49-30-17549_17548
session_id=2019-01-08-13-49-30-17549_17548 action=start_job job_name=internal/core_test build_dir=000040 pid=17548 ppid=26691
Exit code: 0
</pre>

## Запуск одной задачи из другой

Ответственность за реализацию запуска лежит на конкретной компоненте представляющей ядро cis1.  
Общим требованием является то, что входные параметры уже не будут запрашиваться интерактивно, они должны быть установлены в вызывающей задаче перед вызовом дочерней.  
Те параметры, которые не будут установлены перед стартом дочерней задачи, получат значения по умолчанию.  
Если значения по умолчанию не заданы, то такие параметры останутся пустыми.  

## Сессии

В момент старта первой задачи (интерактивно с консоли, или еще как-то) автоматически создается сессия, ей присваивается идентификатор. В каталоге _sessions_ создается лог файл для этой сессии, и _.dat_ файл для записи глобальных переменных этой сессии (см. ниже). Когда "верхняя" задача в цепочке завершается, сессия закрывается.

Таким образом, цепочка задач выполняется внутри одной сессии, что позволяет иметь им общие глобальные переменные, некоторые служебные переменные среды окружения. В лог-файл сессии будут записаны все задачи, которые стартуют в данной сессии, таким образом можно проследить всю цепочку.

## Служебные переменные сессии, находящиеся в environment

*   job_name
*   build_number
*   session_id
*   parent_job_name
*   parent_job_build_number

## Служебные глобальные переменные сессии

*   last_job_name
*   last_job_build_number

## Логика работы job (билда), его артефакты, файлы job

Каждая job находится в своем каталоге.  
В нем лежит файл script, являющийся исполняемым файлом с точки зрения ОС.  
Файл parmas - описание входных параметров job.  
Файл config - всякие конфигурационные свойства этой job.  

При старте первой job в цепочке создается новая сессия.  
Если нужно запрашиваются с консоли входные параметры (если это первая задача в сессии).  
Создается каталог, в котором будет выполнятся билд, в него копируется файл script, и в этом каталоге запускается.  
В этот каталог записывается файл session_id.txt в который пришется идентификатор текущей сессии.
Весь стандартный выхлоп и вывод ошибок записывается в файл output.txt, а код завершения записывается в файл exitcode.txt  

### Формат файла params

Каждая строка файла описывает один параметр.  
Формат строки: param_name=default_value.  
Все параметры строковые. Пример:

<pre>prm1="why?"
prm2=
prm3="third default parameter"
</pre>

### Формат файла config

Каждая строка файла описывает один параметр.  
Формат строки: param_name=value.  
Все параметры строковые. Все возможные параметры:

<pre>keep_last_success_builds - количество предыдущих успешных билдов, которое cis будет хранить на диске (если не задан, то будут храниться все)
keep_last_break_builds - количество предыдущих неуспешных билдов, которое cis будет хранить на диске (если не задан, то будут храниться все)
</pre>

## Формат логов

### Основной файл лога системы

Формат записи:

<pre><$(date +%Y-%m-%d:%T) action=XXXXX> [prm1=XXXX] [prm2=XXXX] <### pid=XXXX ppid=XXXX> [session_id=XXXXXXX]
</pre>

Список событий, которые пишуться в него: TBD...

### Файл лога сессии

Формат записи:

<pre><$(date +%Y-%m-%d-%H-%M-%S) action=XXXXX> [prm1=XXXX] [prm2=XXXX] <### pid=XXXX ppid=XXXX>
</pre>

Список событий, которые пишуться в него: TBD...

# Описание бизнес-логики ВЕБ интерфейса

ВЕБ интерфейс (ВЕБ компонента) берет на себя:

*   всю бизнес-логику управления правами пользователей
*   предоставляет пользователю ВЕБ интерфейс для работы с ядром CIS
*   работает с ядром CIS в соответствие с командами от пользователя.

# Взаимодействие между Ядром и ВЕБ интерфейсом

ВЕБ интерфейс с одной стороны запускает скрипты как регламентирует ядро CIS, читает результат их выполнения, имеет доступ к файлам скриптов и может их читать/менять. С другой стороны, он выдает в виде ВЕБ сайта пользователю возможность управлять всем этим и просматривать результаты выполнения.

Общение с CIS происходит через файловую систему: запуск скрипта - это команда системы, чтение результатов - это чтение содержимого файлов, навигация по проектам и job - это навигация по файловой системе, редактирование job - это изменение файлов job.

Для того, чтобы нотифицировать ВЕБ компоненту о всяких асинхронных событиях имеется http интерфейс у самой ВЕБ компоненты. CIS для того, чтобы сообщить Веб компоненте об этих событиях делает HTTP запрос на специальный URL:localhost...TBD

Список событий, о которых ядро уведомляет ВЕБ компоненту:

*   Запуск job
*   Завершение job
*   Запуск сесси
*   Завершение сессии.
*   TBD...
