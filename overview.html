<HTML>
<HEAD>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<TITLE>
Overview for cis1
</TITLE>
</HEAD>
<BODY>
<h1>Continuous Integration System, Version 1</h1>
<p>
	Это файл overview.html репозитария cis1-docs. 
</p><p>
	В нем содержится описание системы, состав компонент, бизнес-логика системы и каждой компоненты по отдельности, описание взаимодействия между компонентами.
	Версию системы можно найти в файле version.txt этого же репозитария.
</p><p>
	Кроме требований к бизнес-логике и интерфейсу компоненты, имеются требования на состав документации и правила организации репозитариев.
	Их можно найти <a href="devguide.html">здесь</a>.
</p><p>
	Каждая компонента должна удовлетворять требованиям, изложенным в данных документах.
</p>

<h1>Что такое CIS, зачем она нужна</h1>
<p>
	CIS - это инструмент для разработчиков программного обеспечения.
</p><p>
	Он предназначен для автоматизации и связывания в единую цепочку рутинных операций, которые присутствуют в жизненном цикле ПО.
</p><p>
	Это операции: сборки (build), развертывания (deploy), автотестирования (autotesting), диагностика состояния систем (по запросу и периодическая), и т.д.
</p><p>
	Смысл использования этого инструмента: исключить из процесса разработки ручной запуск рутинных операций, и тем самым повысить эффективность работы инженеров.
</p>

<h1>Общее описание бизнес-логики системы</h1>

<h2>Система реализует следующие функции:</h2>
<ul>
	<li>
		ВЕБ интерфейс для пользователя. Все функции системы и управление ей доступны через этот интерфейс.
	</li>
	<li>
		Запуск скриптов (job), сохранение результатов каждого запуска (билда) и их идентификацию, вывода на консоль каждого запуска, статуса завершения.<br />
		Любой скрипт может иметь параметры.<br />
		Любой скрипт может запустить еще один скрипт.<br />
		Каждый скрипт - это исполняемый файл с точки зрения ОС.<br />
	</li>
	<li>
		Скрипты разбиты на группы - проекты. Каждый проект - это отдельный каталог, он может быть репозитарием.
	</li>
	<li>
		Создание/модификацию/удаление скриптов.
	</li>
	<li>
		Скрипты могут запускаться не только через ВЕБ интерфейс, но и из командной строки.
	</li>
	<li>
		Существуют версии системы для Win, Linux, Mac.
	</li>
	<li>
		Возможность запуска скриптов по расписанию.
	</li>
	<li>
		Возможность запуска скриптов по внешнему сигналу - ВЕБ-хуку.
	</li>
	<li>
		Возможность запуска скриптов из самих скриптов (организация цепочек - сессий).
	</li>
	<li>
		Наличие механизма глобальных переменных сессии (эти переменные доступны всем задачам, выполняющимся в пределах этой сессии).
	</li>
	<li>
		Визуализация процесса работы скриптов, работы цепочки скриптов.
	</li>
	<li>
		Удаление старых билдов.
	</li>
	<li>
		Самодиагностику работоспособности системы.
	</li>
	<li>
		Разделение правд доступа к проектам через ВЕБ интерфейс.
	</li>
	<li>
		...
	</li>
</ul>


<h1>Список компонентов</h1>

<ul>
	<li>
		Ядро (core).
	</li>
	<li>
		ВЕБ интерфейс (WEBUI).
	</li>
</ul>


<h1>Описание бизнес логики ядра</h1>

<h2>Основные термины</h2>
<table>
<tr><td>
<i>cis_base_dir</i>
</td><td>
это системная переменная, которая должна быть установлена в environment и в ней должно быть имя каталога в котором находится система.<br />
</td></tr>
<tr><td>
Ядро
</td><td>
несколько скриптов, которые обеспечивают все функции системы, скрипты находятся в подкаталоге <i>core</i>.
</td></tr>
<tr><td>
Проект
</td><td>
Подкаталог внутри каталога <i>jobs</i>, внутри него находятся принадлежащие ему задачи.
</td></tr>
<tr><td>
Задача 
</td><td>
это и каталог, который содержит все необходимое для запуска/результаты запуска, и сам процесс выполнения задачи.
</td></tr>
<tr><td>
Билд
</td><td>
это один сеанс работы задачи, а также и результаты его выполнения, каждый билд выполняется в отдельном подкаталоге внутри задачи 
(имя подкаталога билда - это его номер).
</td></tr>
<tr><td>
Сессия
</td><td>
задачи могут запускать одна другую, таким образом организовывая цепочки выполнения - это и есть сессии. 
Первая задача в цепочке начинает сессию, и она же ее закрывает. При открытии сессии ей присваивается уникальный идентификатор.
Для каждой сессии создается отдельный файл лога в каталоге <i>sessions</i>, имя лог-файла совпадает с идентификатором сессии.
</td></tr>
</table>

<h2>Задачи (jobs)</h2>
<p>
Задачи находятся в подкаталоге <i>jobs</i> системы.
Все задачи разбиты на "проекты", каждый из проектов находится в своем подкаталоге.
</p>
<p>
Внутри каталога задачи находятся:

<ul>
<li>
подкаталоги 000001 - 999999 - здесь хранятся данные билдов (результаты).
</li>
<li>
файл <i>script</i> - это скрипт самой задачи, он и выполняется
</li>
<li>
файл <i>params</i> - описание входных параметров задачи
</li>
<li>
файл <i>config</i> - параметры, которые cis использует в своих целях
</li>
</ul>
</p>


<h2>Размещение системы на диске</h2>

<pre>
\core – ядро CIS (здесь находятся исполняемые файлы, которые и обеспечивают работу ядра)
\jobs  - каталог с «задачами», они разбиты на проекты:
-\internal – специальный проект, который включен прямо в CIS, это всякие служебные ее задачи
   -\job1
	-\script - скрипт этой job
	-\param - файл параметров этой job
	-\config - конфигурационный файл этой job
	-\000001 - каталог, в котором лежат результаты выполнения первого билда этой job
		-\script - файл скрипта, который запускался для выполнения этого билда (в момент старата билда он копируется из каталога выше)
		-\output.txt - содержимое стандартного вывода и вывода ошибок, которое было сформировано в процессе билда
		-\exitcode.txt - код возврата сркипта этой job
   - job2
   -\...
-\project1 – сторонний проект, здесь находятся зачади, сделанные разработчиками проекта, этот проект хранится в другом репозитарии (не связанном с CIS)
   -\job1
   -\job2
   -...
  -... – куча других проектов
\logs – логфайлы работы CIS
\sessions  - здесь находятся логи сессий (логи запусков цепочек jobs), они нам нужны для визуализации работы системы
</pre>


<h2>Запуск задачи</h2>

<p>
Для запуска задачи используем команду системы <i>startjob</i> с параметром проект/задача:
<pre>
$cis_base_dir/startjob internal/core_test
</pre>
</p>
<p>
Если у задачи есть входные параметры, то они будут запрошены с консоли в той последовательности, в которой они указаны в файле paprms.<br />
На выход будут три строки, в первой будет идентификатор сессии, во второй информация о старте задачи, ее имя, номер билда и т.д., в третьей статус завершения:

<pre>
$ ./startjob internal/core_test
2019-01-08-13-49-30-17549_17548
session_id=2019-01-08-13-49-30-17549_17548 action=start_job job_name=internal/core_test build_dir=000040 pid=17548 ppid=26691
Exit code: 0
</pre>
</p>

<h2>Запуск одной задачи из другой</h2>
<p>
Ответственность за реализацию запуска лежит на конкретной компоненте представляющей ядро cis1.<br />
Общим требованием является то, что входные параметры уже не будут запрашиваться интерактивно, они должны быть установлены в вызывающей задаче перед вызовом дочерней.<br />
Те параметры, которые не будут установлены перед стартом дочерней задачи, получат значения по умолчанию.<br />
Если значения по умолчанию не заданы, то такие параметры останутся пустыми.<br />
</p>

<h2>Сессии</h2>

<p>
В момент старта первой задачи (интерактивно с консоли, или еще как-то) автоматически создается сессия, ей присваивается идентификатор.
В каталоге <i>sessions</i> создается лог файл для этой сессии, и <i>.dat</i> файл для записи глобальных переменных этой сессии (см. ниже).
Когда "верхняя" задача в цепочке завершается, сессия закрывается.
</p>
<p>
Таким образом, цепочка задач выполняется внутри одной сессии, что позволяет иметь им общие глобальные переменные, 
некоторые служебные переменные среды окружения.
В лог-файл сессии будут записаны все задачи, которые стартуют в данной сессии, таким образом можно проследить всю цепочку.
</p>

<h2>Служебные переменные сессии, находящиеся в environment</h2>

<ul>
<li>job_name</li>
<li>build_number</li>
<li>session_id</li>
<li>parent_job_name</li>
<li>parent_job_build_number</li>
</ul>

<h2>Служебные глобальные переменные сессии</h2>

<ul>
<li>last_job_name</li>
<li>last_job_build_number</li>
</ul>


<h2>Логика работы job (билда), его артефакты, файлы job</h2>

<p>
Каждая job находится в своем каталоге.<br />
В нем лежит файл script, являющийся исполняемым файлом с точки зрения ОС.<br />
Файл parmas - описание входных параметров job.<br />
Файл config - всякие конфигурационные свойства этой job.<br />
</p>

<p>
При старте первой job в цепочке создается новая сессия.<br />
Если нужно запрашиваются с консоли входные параметры (если это первая задача в сессии).<br />
Создается каталог, в котором будет выполнятся билд, в него копируется файл script, и в этом каталоге запускается.<br />
Весь стандартный выхлоп и вывод ошибок записывается в файл output.txt, а код завершения записывается в файл exitcode.txt<br />
</p>

<h3>Формат файла params</h3>
<p>
Каждая строка файла описывает один параметр.<br />
Формат строки: param_name=default_value.<br />
Все параметры строковые. 
Пример:
</p>

<pre>
prm1="why?"
prm2=
prm3="third default parameter"
</pre>

<h3>Формат файла config</h3>
<p>
Каждая строка файла описывает один параметр.<br />
Формат строки: param_name=value.<br />
Все параметры строковые. 
Все возможные параметры:
</p>
<pre>
keep_last_success_builds - количество предыдущих успешных билдов, которое cis будет хранить на диске (если не задан, то будут храниться все)
keep_last_break_builds - количество предыдущих неуспешных билдов, которое cis будет хранить на диске (если не задан, то будут храниться все)
</pre>


<h2>Формат логов</h2>

<h3>Основной файл лога системы</h3>

<p>
Формат записи:
</p>
<pre>
<$(date +%Y-%m-%d:%T) action=XXXXX> [prm1=XXXX] [prm2=XXXX] <### pid=XXXX ppid=XXXX> [session_id=XXXXXXX]
</pre>
<p>
Список событий, которые пишуться в него: TBD...
</p>

<h3>Файл лога сессии</h3>

<p>
Формат записи:
</p>
<pre>
<$(date +%Y-%m-%d-%H-%M-%S) action=XXXXX> [prm1=XXXX] [prm2=XXXX] <### pid=XXXX ppid=XXXX>
</pre>
<p>
Список событий, которые пишуться в него: TBD...
</p>

<h1>Описание бизнес-логики ВЕБ интерфейса</h1>

<p>
ВЕБ интерфейс (ВЕБ компонента) берет на себя:
</p>

<ul>
	<li>
		всю бизнес-логику управления правами пользователей
	</li><li>
		предоставляет пользователю ВЕБ интерфейс для работы с ядром CIS
	</li><li>
		работает с ядром CIS в соответствие с командами от пользователя.
	</li>
</ul>

<h1>Взаимодействие между Ядром и ВЕБ интерфейсом</h1>

<p>
ВЕБ интерфейс с одной стороны запускает скрипты как регламентирует ядро CIS, читает результат их выполнения, имеет доступ к файлам скриптов и может их читать/менять.
С другой стороны, он выдает в виде ВЕБ сайта пользователю возможность управлять всем этим и просматривать результаты выполнения.
</p>

<p>
Общение с CIS происходит через файловую систему: запуск скрипта - это команда системы, чтение результатов - это чтение содержимого файлов, навигация
по проектам и job - это навигация по файловой системе, редактирование job - это изменение файлов job.
</p>

<p>
Для того, чтобы нотифицировать ВЕБ компоненту о всяких асинхронных событиях имеется http интерфейс у самой ВЕБ компоненты. CIS для того, чтобы сообщить
Веб компоненте об этих событиях делает HTTP запрос на специальный URL:localhost...TBD
</p>
<p>
Список событий, о которых ядро уведомляет ВЕБ компоненту:
</p>
<ul>
	<li>
		Запуск job
	</li>
	<li>
		Завершение job
	</li>
	<li>
		Запуск сесси
	</li>
	<li>
		Завершение сессии.
	</li>
	<li>
		TBD...
	</li>
</ul>


</BODY>
</HTML>
